version: "3.8"

# ============================================================
# metrics-quality-dashboard — Docker Compose
# ============================================================
# Airflow + PostgreSQL 로컬 개발 환경
#
# 사용법:
#   docker-compose up -d          # 전체 기동
#   docker-compose logs -f        # 로그 확인
#   docker-compose down -v        # 종료 및 볼륨 삭제
#
# Airflow UI: http://localhost:8080 (admin / admin)
# PostgreSQL: localhost:5432 (metrics / metrics / metrics_db)
# ============================================================

x-airflow-common: &airflow-common
  image: apache/airflow:2.7.3-python3.11
  environment: &airflow-env
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__CORE__FERNET_KEY: ""
    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "false"
    AIRFLOW__CORE__LOAD_EXAMPLES: "false"
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@airflow-db:5432/airflow
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
    AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE: Asia/Seoul
    # 메트릭 DB 연결
    AIRFLOW_CONN_METRICS_DB: postgresql://metrics:metrics@metrics-db:5432/metrics_db
    # Slack 알림 (선택)
    SLACK_WEBHOOK_URL: ${SLACK_WEBHOOK_URL:-}
  volumes:
    - ./dags:/opt/airflow/dags
    - ./scripts:/opt/airflow/scripts
    - ./sql:/opt/airflow/sql
    - ./config:/opt/airflow/config
    - ./reports:/opt/airflow/reports
    - ./requirements.txt:/requirements.txt
  depends_on:
    airflow-db:
      condition: service_healthy
    metrics-db:
      condition: service_healthy


services:
  # ── Airflow 메타데이터 DB ──
  airflow-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: airflow
      POSTGRES_PASSWORD: airflow
      POSTGRES_DB: airflow
    volumes:
      - airflow_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U airflow"]
      interval: 5s
      retries: 5
    ports:
      - "5433:5432"

  # ── 메트릭 데이터 DB ──
  metrics-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: metrics
      POSTGRES_PASSWORD: metrics
      POSTGRES_DB: metrics_db
    volumes:
      - metrics_db_data:/var/lib/postgresql/data
      - ./sql/kpi_definitions.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U metrics"]
      interval: 5s
      retries: 5
    ports:
      - "5432:5432"

  # ── Airflow Init (DB 마이그레이션 + 관리자 계정) ──
  airflow-init:
    <<: *airflow-common
    entrypoint: /bin/bash
    command:
      - -c
      - |
        pip install --no-cache-dir -r /requirements.txt
        airflow db init
        airflow users create \
          --username admin \
          --password admin \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com || true
        airflow connections add metrics_db \
          --conn-type postgres \
          --conn-host metrics-db \
          --conn-port 5432 \
          --conn-login metrics \
          --conn-password metrics \
          --conn-schema metrics_db || true
    depends_on:
      airflow-db:
        condition: service_healthy

  # ── Airflow Webserver ──
  airflow-webserver:
    <<: *airflow-common
    command: >
      bash -c "pip install --no-cache-dir -r /requirements.txt && airflow webserver"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    depends_on:
      airflow-init:
        condition: service_completed_successfully

  # ── Airflow Scheduler ──
  airflow-scheduler:
    <<: *airflow-common
    command: >
      bash -c "pip install --no-cache-dir -r /requirements.txt && airflow scheduler"
    depends_on:
      airflow-init:
        condition: service_completed_successfully


volumes:
  airflow_db_data:
  metrics_db_data:
